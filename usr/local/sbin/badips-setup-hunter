#!/bin/bash
# badips-setup-hunter - Configure Bad IPs in Hunter Mode
# Usage: sudo badips-setup-hunter [--postgresql]

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

CONFIG_FILE="/usr/local/etc/badips.conf"
HUNTER_TEMPLATE="/usr/local/etc/badips.conf.hunter-template"

echo -e "${BLUE}=== Bad IPs Hunter Mode Setup ===${NC}"
echo ""

# Check if running as root
if [[ $EUID -ne 0 ]]; then
   echo -e "${RED}Error: This script must be run as root${NC}"
   echo "Usage: sudo badips-setup-hunter [--postgresql]"
   exit 1
fi

# Check if already configured
if [[ -f "$CONFIG_FILE" ]]; then
    echo -e "${YELLOW}Warning: Configuration file already exists: $CONFIG_FILE${NC}"
    read -p "Overwrite existing configuration? [y/N]: " OVERWRITE
    if [[ ! "$OVERWRITE" =~ ^[Yy]$ ]]; then
        echo "Keeping existing configuration."
        echo ""
    else
        echo -e "${YELLOW}Backing up existing config...${NC}"
        cp "$CONFIG_FILE" "${CONFIG_FILE}.backup.$(date +%Y%m%d_%H%M%S)"
        echo -e "${GREEN}✓ Backup created${NC}"
    fi
fi

# Copy hunter template
if [[ ! "$OVERWRITE" =~ ^[Yy]$ ]] && [[ -f "$CONFIG_FILE" ]]; then
    echo -e "${YELLOW}Using existing configuration${NC}"
else
    echo -e "${YELLOW}Copying hunter template...${NC}"
    cp "$HUNTER_TEMPLATE" "$CONFIG_FILE"
    echo -e "${GREEN}✓ Hunter configuration created${NC}"
fi

# Set up nftables
echo ""
echo -e "${YELLOW}Setting up nftables...${NC}"

# Check if table exists
if nft list table inet filter &>/dev/null; then
    echo -e "${GREEN}✓ nftables table 'inet filter' already exists${NC}"
else
    echo "Creating nftables table and chain..."
    nft add table inet filter
    nft add chain inet filter input '{ type filter hook input priority 0 ; }'
    echo -e "${GREEN}✓ nftables table created${NC}"
fi

# Check if badipv4 set exists
if nft list set inet filter badipv4 &>/dev/null; then
    echo -e "${GREEN}✓ nftables set 'badipv4' already exists${NC}"
else
    echo "Creating badipv4 set..."
    nft add set inet filter badipv4 '{ type ipv4_addr; flags timeout; }'
    echo -e "${GREEN}✓ nftables set created${NC}"
fi

# Add drop rule if not exists
if nft list chain inet filter input 2>/dev/null | grep -q "ip saddr @badipv4 drop"; then
    echo -e "${GREEN}✓ Drop rule already exists${NC}"
else
    echo "Adding drop rule..."
    nft add rule inet filter input ip saddr @badipv4 drop
    echo -e "${GREEN}✓ Drop rule added${NC}"
fi

# Make nftables persistent
echo ""
echo -e "${YELLOW}Making nftables rules persistent...${NC}"
if command -v nft &> /dev/null; then
    mkdir -p /etc/nftables.d
    nft list ruleset > /etc/nftables.d/bad_ips.nft

    # Check if nftables.conf includes our rules
    if [[ -f /etc/nftables.conf ]]; then
        if ! grep -q "include \"/etc/nftables.d/bad_ips.nft\"" /etc/nftables.conf; then
            echo 'include "/etc/nftables.d/bad_ips.nft"' >> /etc/nftables.conf
            echo -e "${GREEN}✓ Added to nftables.conf${NC}"
        else
            echo -e "${GREEN}✓ Already in nftables.conf${NC}"
        fi
    else
        # Create nftables.conf if it doesn't exist
        cat > /etc/nftables.conf <<EOF
#!/usr/sbin/nft -f
# Bad IPs nftables rules
include "/etc/nftables.d/bad_ips.nft"
EOF
        chmod 755 /etc/nftables.conf
        echo -e "${GREEN}✓ Created nftables.conf${NC}"
    fi

    # Enable nftables service
    systemctl enable nftables 2>/dev/null || true
    echo -e "${GREEN}✓ nftables rules saved${NC}"
fi

echo ""
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${BLUE}  IMPORTANT: Configure Trusted Networks${NC}"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""
echo -e "${YELLOW}You MUST configure 'never_block_cidrs' in the config file!${NC}"
echo ""
echo "This prevents you from locking yourself out."
echo "Add your management network, VPN, or trusted IPs."
echo ""
echo "Example:"
echo "  never_block_cidrs = 192.168.1.0/24, 10.0.0.0/8, YOUR_IP/32"
echo ""
read -p "Edit configuration now? [Y/n]: " EDIT_NOW

if [[ ! "$EDIT_NOW" =~ ^[Nn]$ ]]; then
    ${EDITOR:-nano} "$CONFIG_FILE"
fi

# Check for PostgreSQL flag
SETUP_POSTGRESQL=0
if [[ "$1" == "--postgresql" ]]; then
    SETUP_POSTGRESQL=1
fi

if [[ $SETUP_POSTGRESQL -eq 0 ]]; then
    echo ""
    read -p "Do you want to configure PostgreSQL central database? [y/N]: " SETUP_PG
    if [[ "$SETUP_PG" =~ ^[Yy]$ ]]; then
        SETUP_POSTGRESQL=1
    fi
fi

if [[ $SETUP_POSTGRESQL -eq 1 ]]; then
    echo ""
    echo -e "${BLUE}=== PostgreSQL Configuration ===${NC}"
    echo ""

    if command -v badips-setup-postgresql &> /dev/null; then
        badips-setup-postgresql
    else
        echo -e "${YELLOW}Note: badips-setup-postgresql not found in PATH${NC}"
        echo "You can run it manually later:"
        echo "  sudo /usr/local/sbin/badips-setup-postgresql"
    fi
fi

# Enable and start service
echo ""
echo -e "${YELLOW}Enabling and starting bad_ips service...${NC}"
systemctl enable bad_ips.service
systemctl start bad_ips.service

echo ""
echo -e "${GREEN}✓ Service enabled and started${NC}"

# Check service status
sleep 2
if systemctl is-active --quiet bad_ips.service; then
    echo -e "${GREEN}✓ Service is running${NC}"
else
    echo -e "${RED}✗ Service failed to start${NC}"
    echo "Check logs with: sudo journalctl -u bad_ips -f"
    exit 1
fi

echo ""
echo -e "${GREEN}=== Hunter Mode Setup Complete ===${NC}"
echo ""
echo "Next steps:"
echo "  1. Monitor logs: sudo journalctl -u bad_ips -f"
echo "  2. Check blocked IPs: sudo nft list set inet filter badipv4"
echo "  3. View status: sudo systemctl status bad_ips"
echo ""

if [[ $SETUP_POSTGRESQL -eq 1 ]]; then
    echo "PostgreSQL Integration:"
    echo "  - Local blocks are synced to central database"
    echo "  - Blocks from other servers are pulled automatically"
    echo ""
fi

echo -e "${YELLOW}Important: Review /var/log/syslog for any detector warnings${NC}"
echo ""
