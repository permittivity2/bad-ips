#!/bin/bash
# badips-setup-postgresql - Configure PostgreSQL connection for Bad IPs Phase 10
# Usage: sudo badips-setup-postgresql [--host HOST] [--port PORT] [--database DB] [--user USER] [--password PASS]

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration paths
PASSWORD_FILE="/etc/bad_ips/db_password"
CONFIG_DIR="/etc/bad_ips"
CONFIG_FILE="/usr/local/etc/badips.conf"

# Check for help flag first (before root check)
if [[ "$1" == "--help" ]]; then
    echo "Usage: sudo badips-setup-postgresql [OPTIONS]"
    echo ""
    echo "Options:"
    echo "  --host HOST       PostgreSQL hostname or IP (default: 10.10.0.116)"
    echo "  --port PORT       PostgreSQL port (default: 5432)"
    echo "  --database DB     Database name (default: bad_ips)"
    echo "  --user USER       Database user (default: bad_ips_hunter)"
    echo "  --password PASS   Database password"
    echo ""
    echo "If options are not provided, script runs in interactive mode."
    exit 0
fi

echo -e "${BLUE}=== Bad IPs Phase 10: PostgreSQL Setup ===${NC}"
echo ""

# Check if running as root
if [[ $EUID -ne 0 ]]; then
   echo -e "${RED}Error: This script must be run as root${NC}"
   echo "Usage: sudo badips-setup-postgresql"
   exit 1
fi

# Parse command line arguments (for non-interactive mode)
INTERACTIVE=1
while [[ $# -gt 0 ]]; do
    case $1 in
        --host)
            DB_HOST="$2"
            INTERACTIVE=0
            shift 2
            ;;
        --port)
            DB_PORT="$2"
            INTERACTIVE=0
            shift 2
            ;;
        --database)
            DB_NAME="$2"
            INTERACTIVE=0
            shift 2
            ;;
        --user)
            DB_USER="$2"
            INTERACTIVE=0
            shift 2
            ;;
        --password)
            DB_PASS="$2"
            INTERACTIVE=0
            shift 2
            ;;
        *)
            echo -e "${RED}Unknown option: $1${NC}"
            echo "Use --help for usage information"
            exit 1
            ;;
    esac
done

# Interactive mode: prompt for values
if [[ $INTERACTIVE -eq 1 ]]; then
    echo -e "${YELLOW}This script will configure the PostgreSQL connection for Bad IPs.${NC}"
    echo ""
    echo "Please provide the following information:"
    echo ""

    # PostgreSQL host
    read -p "PostgreSQL hostname or IP [10.10.0.116]: " DB_HOST
    DB_HOST=${DB_HOST:-10.10.0.116}

    # PostgreSQL port
    read -p "PostgreSQL port [5432]: " DB_PORT
    DB_PORT=${DB_PORT:-5432}

    # Database name
    read -p "Database name [bad_ips]: " DB_NAME
    DB_NAME=${DB_NAME:-bad_ips}

    # Database user
    read -p "Database user [bad_ips_hunter]: " DB_USER
    DB_USER=${DB_USER:-bad_ips_hunter}

    # Database password
    read -sp "Database password: " DB_PASS
    echo ""

    if [[ -z "$DB_PASS" ]]; then
        echo -e "${RED}Error: Password cannot be empty${NC}"
        exit 1
    fi

    echo ""
fi

# Verify all required values are set
if [[ -z "$DB_HOST" || -z "$DB_PORT" || -z "$DB_NAME" || -z "$DB_USER" || -z "$DB_PASS" ]]; then
    echo -e "${RED}Error: Missing required parameters${NC}"
    exit 1
fi

echo -e "${BLUE}Configuration Summary:${NC}"
echo "  Host:     $DB_HOST"
echo "  Port:     $DB_PORT"
echo "  Database: $DB_NAME"
echo "  User:     $DB_USER"
echo ""

# Test PostgreSQL connection
echo -e "${YELLOW}Testing PostgreSQL connection...${NC}"

# Check if psql is installed
if ! command -v psql &> /dev/null; then
    echo -e "${RED}Error: psql client not found${NC}"
    echo "Install it with: sudo apt install postgresql-client"
    exit 1
fi

# Test connection
export PGPASSWORD="$DB_PASS"
if psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -d "$DB_NAME" -c "SELECT version();" > /dev/null 2>&1; then
    echo -e "${GREEN}✓ Connection successful${NC}"
else
    echo -e "${RED}✗ Connection failed${NC}"
    echo ""
    echo "Please check:"
    echo "  1. PostgreSQL is running on $DB_HOST:$DB_PORT"
    echo "  2. Database '$DB_NAME' exists"
    echo "  3. User '$DB_USER' has access"
    echo "  4. Firewall allows connections from this host"
    echo "  5. PostgreSQL pg_hba.conf allows connections from this network"
    echo ""
    read -p "Save configuration anyway? [y/N]: " SAVE_ANYWAY
    if [[ ! "$SAVE_ANYWAY" =~ ^[Yy]$ ]]; then
        echo "Configuration not saved."
        exit 1
    fi
fi
unset PGPASSWORD

echo ""

# Create config directory if it doesn't exist
if [[ ! -d "$CONFIG_DIR" ]]; then
    echo -e "${YELLOW}Creating config directory: $CONFIG_DIR${NC}"
    mkdir -p "$CONFIG_DIR"
    chmod 755 "$CONFIG_DIR"
fi

# Save password to file
echo -e "${YELLOW}Saving password to $PASSWORD_FILE${NC}"
echo "$DB_PASS" > "$PASSWORD_FILE"
chmod 600 "$PASSWORD_FILE"
chown root:root "$PASSWORD_FILE"
echo -e "${GREEN}✓ Password file created with secure permissions (600)${NC}"

# Check if config file exists
if [[ -f "$CONFIG_FILE" ]]; then
    echo ""
    echo -e "${YELLOW}Configuration file exists: $CONFIG_FILE${NC}"

    # Check if database section exists
    if grep -q "^\[database\]" "$CONFIG_FILE"; then
        echo "Database section already exists in config file."
        read -p "Update database settings? [y/N]: " UPDATE_CONFIG
        if [[ "$UPDATE_CONFIG" =~ ^[Yy]$ ]]; then
            # Backup existing config
            cp "$CONFIG_FILE" "${CONFIG_FILE}.backup.$(date +%Y%m%d_%H%M%S)"
            echo -e "${GREEN}✓ Backed up existing config${NC}"

            # Update database settings (simple append for now)
            echo ""
            echo -e "${YELLOW}Note: You may need to manually edit $CONFIG_FILE${NC}"
            echo "Add or update the [database] section with:"
            echo ""
            echo "[database]"
            echo "db_host = $DB_HOST"
            echo "db_port = $DB_PORT"
            echo "db_name = $DB_NAME"
            echo "db_user = $DB_USER"
            echo "db_pass_file = $PASSWORD_FILE"
        fi
    else
        echo ""
        read -p "Add database configuration to $CONFIG_FILE? [Y/n]: " ADD_CONFIG
        if [[ ! "$ADD_CONFIG" =~ ^[Nn]$ ]]; then
            # Backup existing config
            cp "$CONFIG_FILE" "${CONFIG_FILE}.backup.$(date +%Y%m%d_%H%M%S)"

            # Append database section
            cat >> "$CONFIG_FILE" <<EOF

# Phase 10: PostgreSQL Central Database
[database]
db_host = $DB_HOST
db_port = $DB_PORT
db_name = $DB_NAME
db_user = $DB_USER
db_pass_file = $PASSWORD_FILE
db_ssl_mode = disable
EOF
            echo -e "${GREEN}✓ Database configuration added to $CONFIG_FILE${NC}"
        fi
    fi
else
    echo -e "${YELLOW}Config file not found: $CONFIG_FILE${NC}"
    echo "BadIPs.pm will use built-in defaults with the password file."
fi

echo ""
echo -e "${GREEN}=== PostgreSQL Setup Complete ===${NC}"
echo ""
echo "Next steps:"
echo "  1. Verify schema exists on PostgreSQL server:"
echo "     psql -h $DB_HOST -U $DB_USER -d $DB_NAME -c '\\dt'"
echo ""
echo "  2. Restart Bad IPs service:"
echo "     sudo systemctl restart bad_ips"
echo ""
echo "  3. Check logs for connection status:"
echo "     sudo journalctl -u bad_ips -f"
echo ""
echo "Configuration saved:"
echo "  Password file: $PASSWORD_FILE"
echo "  Config file:   $CONFIG_FILE"
echo ""
