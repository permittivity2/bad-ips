#!/bin/bash
set -e

case "$1" in
    purge)
        # Remove database directory on purge
        if [ -d /var/lib/bad_ips ]; then
            echo "Removing database directory /var/lib/bad_ips"
            rm -rf /var/lib/bad_ips
        fi

        # Clean up nftables rules and sets
        echo "Cleaning up nftables configuration..."

        # Remove rules that reference our sets (must be done first)
        nft list chain inet filter input 2>/dev/null | grep -q "@never_block" && \
            nft delete rule inet filter input ip saddr @never_block accept 2>/dev/null || true
        nft list chain inet filter input 2>/dev/null | grep -q "@always_block" && \
            nft delete rule inet filter input ip saddr @always_block drop 2>/dev/null || true
        nft list chain inet filter input 2>/dev/null | grep -q "@badipv4" && \
            nft delete rule inet filter input ip saddr @badipv4 drop 2>/dev/null || true

        # Remove sets
        nft delete set inet filter never_block 2>/dev/null || true
        nft delete set inet filter always_block 2>/dev/null || true
        nft delete set inet filter badipv4 2>/dev/null || true

        echo "âœ“ nftables configuration cleaned up"
        ;;

    remove|upgrade|failed-upgrade|abort-install|abort-upgrade|disappear)
        # Do nothing on remove/upgrade - keep database intact
        ;;

    *)
        echo "postrm called with unknown argument \`$1'" >&2
        exit 1
        ;;
esac

# Reload systemd daemon
systemctl daemon-reload || true

exit 0
