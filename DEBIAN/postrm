#!/bin/bash
set -e

# Load service user configuration if exists
if [ -f /etc/default/bad_ips ]; then
    . /etc/default/bad_ips
fi
BADIPS_USER=${BADIPS_USER:-badips}
BADIPS_GROUP=${BADIPS_GROUP:-badips}

case "$1" in
    purge)
        echo "Purging Bad IPs configuration and user..."

        # Remove database directory on purge
        if [ -d /var/lib/bad_ips ]; then
            echo "Removing database directory /var/lib/bad_ips"
            rm -rf /var/lib/bad_ips
        fi

        # Remove log directory on purge
        if [ -d /var/log/bad_ips ]; then
            echo "Removing log directory /var/log/bad_ips"
            rm -rf /var/log/bad_ips
        fi

        # Remove cache directory on purge
        if [ -d /var/cache/badips ]; then
            echo "Removing cache directory /var/cache/badips"
            rm -rf /var/cache/badips
        fi

        # Clean up nftables rules and sets
        echo "Cleaning up nftables configuration..."

        # Remove rules that reference our sets (must be done first)
        nft list chain inet filter input 2>/dev/null | grep -q "@never_block" && \
            nft delete rule inet filter input ip saddr @never_block accept 2>/dev/null || true
        nft list chain inet filter input 2>/dev/null | grep -q "@always_block" && \
            nft delete rule inet filter input ip saddr @always_block drop 2>/dev/null || true
        nft list chain inet filter input 2>/dev/null | grep -q "@badipv4" && \
            nft delete rule inet filter input ip saddr @badipv4 drop 2>/dev/null || true

        # Remove sets
        nft delete set inet filter never_block 2>/dev/null || true
        nft delete set inet filter always_block 2>/dev/null || true
        nft delete set inet filter badipv4 2>/dev/null || true

        echo "✓ nftables configuration cleaned up"

        # Remove sudoers configuration
        if [ -f /etc/sudoers.d/bad_ips ]; then
            echo "Removing sudoers configuration"
            rm -f /etc/sudoers.d/bad_ips
            echo "✓ Sudoers configuration removed"
        fi

        # Remove systemd drop-in directory
        if [ -d /etc/systemd/system/bad_ips.service.d ]; then
            echo "Removing systemd drop-in configuration"
            rm -rf /etc/systemd/system/bad_ips.service.d
            echo "✓ Systemd drop-in removed"
        fi

        # Remove service user configuration
        if [ -f /etc/default/bad_ips ]; then
            echo "Removing service user configuration"
            rm -f /etc/default/bad_ips
            echo "✓ Service user configuration removed"
        fi

        # Remove service user and group
        if getent passwd "$BADIPS_USER" > /dev/null; then
            echo "Removing system user: $BADIPS_USER"
            deluser --system "$BADIPS_USER" 2>/dev/null || true
            echo "✓ System user removed"
        fi

        # Remove group if it still exists and is empty
        if getent group "$BADIPS_GROUP" > /dev/null 2>&1; then
            delgroup --system "$BADIPS_GROUP" 2>/dev/null || true
        fi

        echo "✓ Bad IPs purge complete"
        ;;

    remove|upgrade|failed-upgrade|abort-install|abort-upgrade|disappear)
        # On remove (but not purge), clean up systemd and sudoers but keep database/logs
        if [ "$1" = "remove" ]; then
            # Remove sudoers configuration on remove
            if [ -f /etc/sudoers.d/bad_ips ]; then
                echo "Removing sudoers configuration"
                rm -f /etc/sudoers.d/bad_ips
            fi

            # Remove systemd drop-in on remove
            if [ -d /etc/systemd/system/bad_ips.service.d ]; then
                echo "Removing systemd drop-in configuration"
                rm -rf /etc/systemd/system/bad_ips.service.d
            fi
        fi
        # Do nothing on upgrade - keep everything intact
        ;;

    *)
        echo "postrm called with unknown argument \`$1'" >&2
        exit 1
        ;;
esac

# Reload systemd daemon
systemctl daemon-reload || true

exit 0
